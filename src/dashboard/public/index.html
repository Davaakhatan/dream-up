<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.gstatic.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https://storage.googleapis.com; connect-src 'self' https://*.firebaseio.com https://*.googleapis.com https://*.up.railway.app https://*.railway.app;">
  <title>DreamUp QA Dashboard</title>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
  <script src="/firebase-config.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #0f0f23;
      --bg-secondary: #1a1a2e;
      --bg-card: #16213e;
      --text-primary: #ffffff;
      --text-secondary: #a0a0b8;
      --accent: #00d4ff;
      --accent-hover: #00b8e6;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      --border: #2d3748;
      --shadow: rgba(0, 0, 0, 0.3);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
      background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.6;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    header {
      margin-bottom: 4rem;
      text-align: center;
      padding-bottom: 2rem;
      border-bottom: 1px solid var(--border);
    }

    h1 {
      font-size: 3rem;
      font-weight: 800;
      margin-bottom: 0.75rem;
      background: linear-gradient(135deg, var(--accent) 0%, #6366f1 50%, #8b5cf6 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: -0.5px;
      line-height: 1.1;
    }

    .subtitle {
      color: var(--text-secondary);
      font-size: 1rem;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: linear-gradient(135deg, var(--bg-card) 0%, rgba(22, 33, 62, 0.8) 100%);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 2rem 1.5rem;
      text-align: center;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--accent), transparent);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 32px rgba(0, 212, 255, 0.15);
      border-color: rgba(0, 212, 255, 0.3);
    }

    .stat-card:hover::before {
      opacity: 1;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .stat-label {
      color: var(--text-secondary);
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-pass { color: var(--success); }
    .status-partial { color: var(--warning); }
    .status-fail, .status-error { color: var(--error); }

    .reports-list {
      display: grid;
      gap: 1.5rem;
    }

    .report-card {
      background: linear-gradient(135deg, var(--bg-card) 0%, rgba(22, 33, 62, 0.9) 100%);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 2rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .report-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: var(--accent);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .report-card:hover {
      border-color: rgba(0, 212, 255, 0.5);
      box-shadow: 0 8px 32px rgba(0, 212, 255, 0.2);
      transform: translateY(-2px);
    }

    .report-card:hover::before {
      opacity: 1;
    }

    .report-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .report-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--accent);
      word-break: break-all;
      transition: color 0.2s;
    }

    .report-title:hover {
      color: var(--accent-hover);
      text-decoration: underline;
    }

    .report-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 24px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border: 1px solid;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .badge-pass { 
      background: rgba(16, 185, 129, 0.15); 
      color: var(--success); 
      border-color: rgba(16, 185, 129, 0.3);
    }
    .badge-partial { 
      background: rgba(245, 158, 11, 0.15); 
      color: var(--warning); 
      border-color: rgba(245, 158, 11, 0.3);
    }
    .badge-fail, .badge-error { 
      background: rgba(239, 68, 68, 0.15); 
      color: var(--error); 
      border-color: rgba(239, 68, 68, 0.3);
    }

    .report-meta {
      display: flex;
      gap: 2rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
      font-size: 0.875rem;
    }

    .meta-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--text-secondary);
      transition: color 0.2s;
    }

    .meta-item:hover {
      color: var(--text-primary);
    }

    .meta-item svg {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
      opacity: 0.7;
    }

    .score-bar {
      width: 100%;
      height: 8px;
      background: var(--border);
      border-radius: 4px;
      overflow: hidden;
      margin: 1rem 0;
    }

    .score-fill {
      height: 100%;
      transition: width 0.3s ease;
      border-radius: 4px;
    }

    .score-high { background: var(--success); }
    .score-medium { background: var(--warning); }
    .score-low { background: var(--error); }

    .issues-list {
      margin-top: 1rem;
    }

    .issue-item {
      padding: 0.875rem 1rem;
      border-radius: 6px;
      margin-bottom: 0.75rem;
      font-size: 0.875rem;
      line-height: 1.5;
      border-left: 3px solid;
      transition: all 0.2s;
    }

    .issue-item:hover {
      transform: translateX(4px);
    }

    .issue-critical {
      background: rgba(239, 68, 68, 0.1);
      border-left-color: var(--error);
      color: #fca5a5;
    }

    .issue-warning {
      background: rgba(245, 158, 11, 0.1);
      border-left-color: var(--warning);
      color: #fcd34d;
    }

    .issue-info {
      background: rgba(59, 130, 246, 0.1);
      border-left-color: #3b82f6;
      color: #93c5fd;
    }

    .issue-severity {
      display: inline-block;
      font-weight: 600;
      margin-right: 0.5rem;
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.5px;
    }

    .screenshots-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .screenshot-item {
      border-radius: 12px;
      overflow: hidden;
      border: 2px solid var(--border);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      position: relative;
      background: var(--bg-secondary);
    }

    .screenshot-item::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), transparent);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .screenshot-item:hover {
      transform: scale(1.05) translateY(-4px);
      border-color: var(--accent);
      box-shadow: 0 8px 24px rgba(0, 212, 255, 0.3);
    }

    .screenshot-item:hover::after {
      opacity: 1;
    }

    .screenshot-item img {
      width: 100%;
      height: auto;
      display: block;
      object-fit: cover;
    }

    .screenshot-item:hover .screenshot-label {
      opacity: 1 !important;
    }

    .screenshot-clickable {
      cursor: pointer;
      position: relative;
    }

    .screenshot-label-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(to top, rgba(0,0,0,0.85), rgba(0,0,0,0.4), transparent);
      padding: 0.75rem;
      color: white;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
    }

    .screenshot-item:hover .screenshot-label-overlay {
      opacity: 1;
    }

    .screenshot-label-text {
      font-size: 0.875rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
      text-transform: capitalize;
    }

    .screenshot-label-time {
      font-size: 0.75rem;
      opacity: 0.8;
    }

    .screenshot-more {
      grid-column: span 1;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      font-size: 0.875rem;
      cursor: pointer;
      border: 2px dashed var(--border);
      border-radius: 12px;
      transition: all 0.2s;
    }

    .screenshot-more:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    /* Screenshot Modal */
    .screenshot-modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      backdrop-filter: blur(10px);
      animation: fadeIn 0.2s ease-out;
    }

    .screenshot-modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .screenshot-modal-content {
      position: relative;
      max-width: 90vw;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
    }

    .screenshot-modal-image {
      max-width: 100%;
      max-height: 80vh;
      object-fit: contain;
      border-radius: 8px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    .screenshot-modal-info {
      color: white;
      text-align: center;
      padding: 1rem;
    }

    .screenshot-modal-label {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      text-transform: capitalize;
    }

    .screenshot-modal-time {
      font-size: 0.875rem;
      opacity: 0.7;
    }

    .screenshot-modal-close {
      position: absolute;
      top: 2rem;
      right: 2rem;
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      color: white;
    }

    .screenshot-modal-close:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.4);
      transform: rotate(90deg);
    }

    .screenshot-modal-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      color: white;
    }

    .screenshot-modal-nav:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.4);
    }

    .screenshot-modal-prev {
      left: 2rem;
    }

    .screenshot-modal-next {
      right: 2rem;
    }

    .screenshot-modal-nav:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .loading {
      text-align: center;
      padding: 3rem;
      color: var(--text-secondary);
    }

    .spinner {
      border: 3px solid var(--border);
      border-top: 3px solid var(--accent);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--text-secondary);
    }

    .empty-state svg {
      width: 64px;
      height: 64px;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    /* Pipeline Animation Styles */
    .pipeline-demo {
      background: linear-gradient(135deg, var(--bg-card) 0%, rgba(22, 33, 62, 0.9) 100%);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 2rem;
      margin-bottom: 3rem;
      position: relative;
      overflow: hidden;
    }

    .pipeline-demo::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--accent), transparent);
      animation: shimmer 3s infinite;
    }

    @keyframes shimmer {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 1; }
    }

    .pipeline-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }

    .pipeline-header h2 {
      font-size: 1.5rem;
      font-weight: 600;
      background: linear-gradient(135deg, var(--accent), #6366f1);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .toggle-btn, .pipeline-btn {
      padding: 0.5rem 1rem;
      background: rgba(0, 212, 255, 0.1);
      border: 1px solid rgba(0, 212, 255, 0.3);
      border-radius: 8px;
      color: var(--accent);
      cursor: pointer;
      font-size: 0.875rem;
      transition: all 0.2s;
    }

    .toggle-btn:hover, .pipeline-btn:hover {
      background: rgba(0, 212, 255, 0.2);
      border-color: var(--accent);
      transform: translateY(-2px);
    }

    .pipeline-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .pipeline-step {
      flex: 1;
      min-width: 150px;
      text-align: center;
      padding: 1.5rem;
      background: rgba(26, 26, 46, 0.5);
      border: 2px solid var(--border);
      border-radius: 12px;
      transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      opacity: 0.5;
      transform: scale(0.95);
      position: relative;
      overflow: hidden;
    }

    .pipeline-step::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), transparent);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .pipeline-step.active {
      opacity: 1;
      transform: scale(1.05);
      border-color: var(--accent);
      box-shadow: 0 8px 24px rgba(0, 212, 255, 0.3);
      background: rgba(0, 212, 255, 0.05);
    }

    .pipeline-step.active::before {
      opacity: 1;
    }

    .pipeline-step.completed {
      opacity: 0.8;
      border-color: var(--success);
    }

    .step-icon {
      width: 48px;
      height: 48px;
      margin: 0 auto 0.5rem;
      color: var(--text-secondary);
      transition: all 0.3s;
      filter: drop-shadow(0 2px 8px rgba(0, 212, 255, 0.2));
    }

    .pipeline-step.active .step-icon {
      color: var(--accent);
      transform: scale(1.1);
    }

    .pipeline-step.completed .step-icon {
      color: var(--success);
    }

    .step-icon svg {
      width: 100%;
      height: 100%;
    }


    .step-label {
      font-weight: 600;
      font-size: 1rem;
      margin-bottom: 0.5rem;
      color: var(--text-primary);
    }

    .step-description {
      font-size: 0.75rem;
      color: var(--text-secondary);
      line-height: 1.4;
    }

    .step-status {
      font-weight: 500;
      animation: pulse-text 2s ease-in-out infinite;
    }

    @keyframes pulse-text {
      0%, 100% { opacity: 0.7; }
      50% { opacity: 1; }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.1); opacity: 0.8; }
    }

    /* Browser Simulation Styles */
    .browser-simulation {
      margin-bottom: 3rem;
      animation: slideDown 0.5s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .browser-window {
      background: #1e1e1e;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      border: 1px solid var(--border);
    }

    .browser-header {
      background: #2d2d2d;
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      border-bottom: 1px solid var(--border);
    }

    .browser-controls {
      display: flex;
      gap: 0.5rem;
    }

    .browser-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }

    .browser-dot.red {
      background: #ff5f57;
    }

    .browser-dot.yellow {
      background: #ffbd2e;
    }

    .browser-dot.green {
      background: #28ca42;
    }

    .browser-address-bar {
      flex: 1;
      background: #1e1e1e;
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      font-size: 0.875rem;
      color: var(--text-primary);
      font-family: 'Monaco', 'Menlo', monospace;
    }

    .browser-url {
      color: var(--accent);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .browser-actions {
      color: var(--text-secondary);
      cursor: not-allowed;
      opacity: 0.5;
    }

    .browser-content {
      background: white;
      min-height: 400px;
      position: relative;
    }

    .browser-page {
      width: 100%;
      height: 100%;
      min-height: 400px;
      background: white;
      position: relative;
      overflow: hidden;
    }

    .browser-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      min-height: 400px;
      color: #666;
      font-size: 0.875rem;
    }

    .spinner-small {
      width: 32px;
      height: 32px;
      border: 3px solid rgba(0, 0, 0, 0.1);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 1rem;
    }

    .browser-game-content {
      padding: 2rem;
      text-align: center;
      color: #333;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    .browser-game-content h2 {
      color: #222;
      margin-bottom: 1rem;
    }

    .browser-status {
      background: #2d2d2d;
      padding: 0.5rem 1rem;
      border-top: 1px solid var(--border);
      font-size: 0.75rem;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .browser-status::before {
      content: '';
      width: 8px;
      height: 8px;
      background: var(--success);
      border-radius: 50%;
      animation: pulse-dot 2s ease-in-out infinite;
    }

    @keyframes pulse-dot {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .browser-status.loading::before {
      background: var(--accent);
      animation: pulse-dot 1s ease-in-out infinite;
    }

    .browser-status.error::before {
      background: var(--error);
    }

    .pipeline-arrow {
      width: 32px;
      height: 32px;
      color: var(--text-secondary);
      opacity: 0.3;
      transition: all 0.3s;
      flex-shrink: 0;
    }

    .pipeline-arrow svg {
      width: 100%;
      height: 100%;
    }

    .pipeline-step.active ~ .pipeline-arrow,
    .pipeline-step.completed ~ .pipeline-arrow {
      opacity: 1;
      color: var(--accent);
    }


    /* Test Runner Styles */
    .test-runner {
      background: linear-gradient(135deg, var(--bg-card) 0%, rgba(22, 33, 62, 0.9) 100%);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 2rem;
      margin-bottom: 3rem;
    }

    .test-runner-header {
      margin-bottom: 1.5rem;
    }

    .test-runner-header h2 {
      font-size: 1.5rem;
      font-weight: 600;
      background: linear-gradient(135deg, var(--accent), #6366f1);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .test-runner-form {
      display: flex;
      gap: 1rem;
      align-items: stretch;
    }

    .url-input {
      flex: 1;
      padding: 1rem 1.5rem;
      background: rgba(26, 26, 46, 0.5);
      border: 2px solid var(--border);
      border-radius: 12px;
      color: var(--text-primary);
      font-size: 1rem;
      transition: all 0.3s;
    }

    .url-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
    }

    .url-input::placeholder {
      color: var(--text-secondary);
      opacity: 0.6;
    }

    .run-test-btn {
      padding: 1rem 2rem;
      background: linear-gradient(135deg, var(--accent), #6366f1);
      border: none;
      border-radius: 12px;
      color: white;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      white-space: nowrap;
    }

    .run-test-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 212, 255, 0.3);
    }

    .run-test-btn:active:not(:disabled) {
      transform: translateY(0);
    }

    .run-test-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border);
      padding: 0.875rem 1.5rem;
      border-radius: 12px;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      white-space: nowrap;
    }

    .btn-secondary:hover {
      background: var(--bg-tertiary);
      border-color: var(--accent);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 212, 255, 0.2);
    }

    .btn-secondary:active {
      transform: translateY(0);
    }

    .btn-spinner {
      animation: spin 1s linear infinite;
    }

    .btn-spinner svg {
      width: 16px;
      height: 16px;
    }

    .test-status {
      margin-top: 1.5rem;
      padding: 1rem;
      border-radius: 8px;
      font-size: 0.875rem;
    }

    .test-status.running {
      background: rgba(59, 130, 246, 0.1);
      border-left: 3px solid #3b82f6;
      color: #93c5fd;
    }

    .test-status.success {
      background: rgba(16, 185, 129, 0.1);
      border-left: 3px solid var(--success);
      color: #6ee7b7;
    }

    .test-status.error {
      background: rgba(239, 68, 68, 0.1);
      border-left: 3px solid var(--error);
      color: #fca5a5;
    }

    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }

      h1 {
        font-size: 2rem;
      }

      .report-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .pipeline-container {
        flex-direction: column;
      }

      .pipeline-arrow {
        transform: rotate(90deg);
        margin: 0.5rem 0;
      }

      .test-runner-form {
        flex-direction: column;
      }

      .run-test-btn {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>DreamUp QA Dashboard</h1>
      <p class="subtitle">Browser Game Testing Results & Analytics</p>
    </header>

    <!-- Test Runner Section -->
    <div class="test-runner">
      <div class="test-runner-header">
        <h2>Test a Game</h2>
      </div>
      <div class="test-runner-form">
        <input 
          type="url" 
          id="game-url-input" 
          class="url-input" 
          placeholder="Enter game URL (e.g., https://play2048.co/)" 
          value=""
        >
        <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; width: 100%;">
          <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; color: var(--text-secondary); font-size: 0.875rem; user-select: none; white-space: nowrap;">
            <input type="checkbox" id="show-browser-checkbox" style="cursor: pointer; width: 18px; height: 18px;">
            <span>Show browser window</span>
          </label>
          <div style="display: flex; gap: 0.75rem; margin-left: auto;">
            <button id="run-test-btn" class="run-test-btn">
              <span class="btn-text">Run Test</span>
              <span class="btn-spinner" style="display: none;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
                </svg>
              </span>
            </button>
            <button id="reset-test-btn" class="btn-secondary" style="display: none;" title="Reset stuck test">
              <span>Reset</span>
            </button>
          </div>
        </div>
      </div>
      <div id="test-status" class="test-status" style="display: none;"></div>
    </div>

    <!-- Browser Simulation Window (Shown during test) -->
    <div id="browser-simulation" class="browser-simulation" style="display: none;">
      <div class="browser-window">
        <div class="browser-header">
          <div class="browser-controls">
            <span class="browser-dot red"></span>
            <span class="browser-dot yellow"></span>
            <span class="browser-dot green"></span>
          </div>
          <div class="browser-address-bar">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 0.5rem;">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="M21 21l-4.35-4.35"></path>
            </svg>
            <span id="browser-url" class="browser-url">about:blank</span>
          </div>
          <div class="browser-actions">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
          </div>
        </div>
        <div class="browser-content">
          <div id="browser-page" class="browser-page">
            <div class="browser-loading">
              <div class="spinner-small"></div>
              <p>Loading...</p>
            </div>
          </div>
        </div>
        <div class="browser-status" id="browser-status">
          <span>Ready</span>
        </div>
      </div>
    </div>

    <!-- Pipeline Animation Section (Hidden by default, shown when test starts) -->
    <div id="pipeline-demo" class="pipeline-demo" style="display: none;">
      <div class="pipeline-header">
        <h2>How Testing Works</h2>
        <button id="toggle-pipeline" class="toggle-btn">Hide</button>
      </div>
      <div class="pipeline-container">
        <div class="pipeline-step active" data-step="1">
          <div class="step-icon">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
            </svg>
          </div>
          <div class="step-label">Load Game</div>
          <div class="step-description">Opens browser and navigates to game URL</div>
          <div class="step-status" style="display: none; margin-top: 0.5rem; font-size: 0.75rem; color: var(--accent);"></div>
        </div>
        <div class="pipeline-arrow">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M5 12h14M12 5l7 7-7 7"/>
          </svg>
        </div>
        <div class="pipeline-step" data-step="2">
          <div class="step-icon">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <circle cx="9" cy="9" r="2"></circle>
              <path d="M21 15l-3.086-3.086a2 2 0 0 0-2.828 0L6 21"></path>
            </svg>
          </div>
          <div class="step-label">Capture Evidence</div>
          <div class="step-description">Takes screenshots and captures console logs</div>
          <div class="step-status" style="display: none; margin-top: 0.5rem; font-size: 0.75rem; color: var(--accent);"></div>
        </div>
        <div class="pipeline-arrow">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M5 12h14M12 5l7 7-7 7"/>
          </svg>
        </div>
        <div class="pipeline-step" data-step="3">
          <div class="step-icon">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 11l3 3L22 4"></path>
              <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
            </svg>
          </div>
          <div class="step-label">Interact</div>
          <div class="step-description">Simulates gameplay interactions</div>
          <div class="step-status" style="display: none; margin-top: 0.5rem; font-size: 0.75rem; color: var(--accent);"></div>
        </div>
        <div class="pipeline-arrow">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M5 12h14M12 5l7 7-7 7"/>
          </svg>
        </div>
        <div class="pipeline-step" data-step="4">
          <div class="step-icon">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <path d="M12 16v-4M12 8h.01"></path>
            </svg>
          </div>
          <div class="step-label">AI Analysis</div>
          <div class="step-description">GPT-4 Vision evaluates playability</div>
          <div class="step-status" style="display: none; margin-top: 0.5rem; font-size: 0.75rem; color: var(--accent);"></div>
        </div>
        <div class="pipeline-arrow">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M5 12h14M12 5l7 7-7 7"/>
          </svg>
        </div>
        <div class="pipeline-step" data-step="5">
          <div class="step-icon">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"></path>
            </svg>
          </div>
          <div class="step-label">Generate Report</div>
          <div class="step-description">Structured JSON with scores and issues</div>
          <div class="step-status" style="display: none; margin-top: 0.5rem; font-size: 0.75rem; color: var(--accent);"></div>
        </div>
      </div>
    </div>

    <!-- Screenshot Modal -->
    <div id="screenshot-modal" class="screenshot-modal">
      <button class="screenshot-modal-close" id="modal-close">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
      <button class="screenshot-modal-nav screenshot-modal-prev" id="modal-prev" title="Previous screenshot">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
      </button>
      <button class="screenshot-modal-nav screenshot-modal-next" id="modal-next" title="Next screenshot">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
      </button>
      <div class="screenshot-modal-content">
        <img id="modal-image" class="screenshot-modal-image" src="" alt="Screenshot">
        <div class="screenshot-modal-info">
          <div id="modal-label" class="screenshot-modal-label"></div>
          <div id="modal-time" class="screenshot-modal-time"></div>
        </div>
      </div>
    </div>

    <div id="stats" class="stats-grid"></div>
    <div id="reports" class="reports-list">
      <div class="loading">
        <div class="spinner"></div>
        <p>Loading reports...</p>
      </div>
    </div>
  </div>

  <script>
    // Suppress console errors from browser extensions (harmless)
    const originalError = console.error;
    const originalWarn = console.warn;
    const originalLog = console.log;
    
    console.error = function(...args) {
      const message = args.join(' ');
      // Filter out browser extension errors
      if (message.includes('chrome-extension://') || 
          message.includes('background.js') ||
          message.includes('Could not establish connection') ||
          message.includes('FrameIsBrowserFrameError') ||
          message.includes('FrameDoesNotExistError') ||
          message.includes('ERR_FILE_NOT_FOUND') ||
          message.includes('Failed to load resource') ||
          message.includes('completion_list.html') ||
          message.includes('utils.js') ||
          message.includes('extensionState.js') ||
          message.includes('heuristicsRedefinitions.js') ||
          message.includes('ControlLooksLikePasswordCredentialField') ||
          message.includes('postMessage')) {
        return; // Don't log extension errors
      }
      originalError.apply(console, args);
    };

    console.warn = function(...args) {
      const message = args.join(' ');
      // Filter out browser extension warnings
      if (message.includes('chrome-extension://') || 
          message.includes('Failed to load resource') ||
          message.includes('ERR_FILE_NOT_FOUND') ||
          message.includes('heuristicsRedefinitions') ||
          message.includes('extensionState') ||
          message.includes('utils.js') ||
          message.includes('completion_list.html')) {
        return;
      }
      originalWarn.apply(console, args);
    };
    
    // Also filter console.log for extension messages
    console.log = function(...args) {
      const message = args.join(' ');
      if (message.includes('chrome-extension://') || 
          message.includes('ERR_FILE_NOT_FOUND') ||
          message.includes('heuristicsRedefinitions') ||
          message.includes('extensionState') ||
          message.includes('utils.js') ||
          message.includes('completion_list.html')) {
        return; // Suppress extension logs
      }
      originalLog.apply(console, args);
    };
    
    // Filter network errors from extensions
    window.addEventListener('error', function(e) {
      const filename = e.filename || '';
      const message = e.message || '';
      if (filename.includes('chrome-extension://') ||
          message.includes('ERR_FILE_NOT_FOUND') ||
          message.includes('chrome-extension://') ||
          message.includes('Failed to load resource') ||
          message.includes('heuristicsRedefinitions') ||
          message.includes('extensionState') ||
          message.includes('utils.js') ||
          message.includes('completion_list.html') ||
          message.includes('ControlLooksLikePasswordCredentialField') ||
          message.includes('FrameIsBrowserFrameError') ||
          message.includes('FrameDoesNotExistError')) {
        e.preventDefault();
        e.stopPropagation();
        return false;
      }
    }, true);
    
    // Filter unhandled promise rejections from extensions
    window.addEventListener('unhandledrejection', function(e) {
      const reason = e.reason?.message || e.reason?.toString() || '';
      if (reason.includes('chrome-extension://') || 
          reason.includes('ERR_FILE_NOT_FOUND') ||
          reason.includes('Blocked extension request') ||
          reason.includes('Could not establish connection') ||
          reason.includes('Receiving end does not exist') ||
          reason.includes('FrameIsBrowserFrameError') ||
          reason.includes('FrameDoesNotExistError') ||
          reason.includes('ControlLooksLikePasswordCredentialField') ||
          reason.includes('postMessage') ||
          reason.includes('message port closed')) {
        e.preventDefault();
        return false;
      }
    });

    // API Base URL - can be configured via localStorage or defaults to same origin
    // For Firebase Hosting, you may need to set this to your API server URL
    // Example: localStorage.setItem('API_BASE', 'http://localhost:3000');
    const API_BASE = localStorage.getItem('API_BASE') || window.location.origin;

    // Initialize Firebase
    let firebaseApp = null;
    let firestore = null;
    let firebaseInitialized = false;
    
    // Initialize Firebase when scripts are loaded
    function initializeFirebase() {
      try {
        if (window.FIREBASE_CONFIG && window.firebase) {
          // Check if already initialized
          if (window.firebase.apps.length > 0) {
            firebaseApp = window.firebase.apps[0];
          } else {
            firebaseApp = window.firebase.initializeApp(window.FIREBASE_CONFIG);
          }
          
          // Initialize Firestore
          firestore = window.firebase.firestore();
          
          // Enable offline persistence (optional, but helpful)
          try {
            firestore.enablePersistence({ synchronizeTabs: true }).catch(err => {
              if (err.code === 'failed-precondition') {
                console.warn('âš  Firestore persistence requires all tabs to be closed');
              } else if (err.code === 'unimplemented') {
                console.warn('âš  Firestore persistence not supported in this browser');
              }
            });
          } catch (persistenceError) {
            // Ignore persistence errors - not critical
          }
          
          firebaseInitialized = true;
          console.log('âœ“ Firebase initialized successfully');
          console.log('âœ“ Firestore ready');
        } else {
          console.warn('âš  Firebase config or SDK not available');
        }
      } catch (error) {
        console.warn('âš  Firebase initialization failed:', error);
        firebaseInitialized = false;
      }
    }
    
    // Wait for Firebase SDK to load, then initialize
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        // Wait a bit for Firebase scripts to load
        setTimeout(initializeFirebase, 100);
      });
    } else {
      // DOM already loaded, wait for Firebase scripts
      setTimeout(initializeFirebase, 100);
    }

    // Screenshot modal state
    let currentScreenshots = [];
    let currentScreenshotIndex = 0;

    // Convert screenshot label to human-readable text
    function getScreenshotLabel(label, index) {
      if (!label) {
        const labels = ['Initial Load', 'After Interaction', 'Gameplay', 'Final State'];
        return labels[index] || `Screenshot ${index + 1}`;
      }
      
      // Convert common labels
      const labelMap = {
        'initial-load': 'Initial Load',
        'after-movement': 'After Movement',
        'after-click': 'After Click',
        'gameplay': 'Gameplay',
        'final-state': 'Final State',
        'error-state': 'Error State',
      };
      
      // Convert kebab-case to Title Case
      if (labelMap[label.toLowerCase()]) {
        return labelMap[label.toLowerCase()];
      }
      
      // Convert kebab-case or snake_case to Title Case
      return label
        .replace(/[-_]/g, ' ')
        .split(' ')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
        .join(' ');
    }

    // Screenshot modal functions
    function openScreenshotModal(screenshots, startIndex) {
      currentScreenshots = screenshots;
      currentScreenshotIndex = startIndex;
      showScreenshot(currentScreenshotIndex);
      document.getElementById('screenshot-modal').classList.add('active');
      document.body.style.overflow = 'hidden'; // Prevent background scrolling
    }

    function closeScreenshotModal() {
      document.getElementById('screenshot-modal').classList.remove('active');
      document.body.style.overflow = ''; // Restore scrolling
      currentScreenshots = [];
      currentScreenshotIndex = 0;
    }

    function showScreenshot(index) {
      if (index < 0 || index >= currentScreenshots.length) return;
      
      currentScreenshotIndex = index;
      const screenshot = currentScreenshots[index];
      const modalImage = document.getElementById('modal-image');
      const modalLabel = document.getElementById('modal-label');
      const modalTime = document.getElementById('modal-time');
      const modalPrev = document.getElementById('modal-prev');
      const modalNext = document.getElementById('modal-next');
      
      // Use Firebase Storage URL if available, otherwise use API endpoint
      const screenshotUrl = screenshot.url || screenshot.storageUrl || `${API_BASE}/api/screenshots/${screenshot.filename}`;
      modalImage.src = screenshotUrl;
      modalLabel.textContent = getScreenshotLabel(screenshot.label, index);
      modalTime.textContent = new Date(screenshot.timestamp).toLocaleString();
      
      // Update navigation buttons
      modalPrev.disabled = index === 0;
      modalNext.disabled = index === currentScreenshots.length - 1;
    }

    function nextScreenshot() {
      if (currentScreenshotIndex < currentScreenshots.length - 1) {
        showScreenshot(currentScreenshotIndex + 1);
      }
    }

    function prevScreenshot() {
      if (currentScreenshotIndex > 0) {
        showScreenshot(currentScreenshotIndex - 1);
      }
    }

    // Modal event listeners
    document.addEventListener('DOMContentLoaded', () => {
      const modal = document.getElementById('screenshot-modal');
      const modalClose = document.getElementById('modal-close');
      const modalPrev = document.getElementById('modal-prev');
      const modalNext = document.getElementById('modal-next');
      
      modalClose?.addEventListener('click', closeScreenshotModal);
      modalPrev?.addEventListener('click', prevScreenshot);
      modalNext?.addEventListener('click', nextScreenshot);
      
      // Close on background click
      modal?.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeScreenshotModal();
        }
      });
      
      // Close on Escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal?.classList.contains('active')) {
          closeScreenshotModal();
        } else if (e.key === 'ArrowLeft' && modal?.classList.contains('active')) {
          prevScreenshot();
        } else if (e.key === 'ArrowRight' && modal?.classList.contains('active')) {
          nextScreenshot();
        }
      });
    });

    async function fetchReports() {
      // Try Firestore first (only if API fails and Firestore is available)
      // Skip Firestore for Railway deployments - use API only
      const useFirestore = false; // Disable Firestore when using Railway
      
      if (useFirestore && firebaseInitialized && firestore) {
        try {
          const snapshot = await firestore.collection('reports')
            .orderBy('timestamp', 'desc')
            .limit(100) // Limit to 100 most recent reports
            .get();
          
          if (!snapshot.empty) {
            const reports = snapshot.docs.map(doc => {
              const data = doc.data();
              // Remove Firestore metadata fields
              const { createdAt, updatedAt, id, ...report } = data;
              return report;
            });
            
            console.log(`âœ“ Loaded ${reports.length} reports from Firestore`);
            hideApiUnavailableMessage();
            enableTestRunner();
            return reports;
          }
        } catch (firestoreError) {
          // Silently fail - Firestore is optional
          // Only use API endpoint
        }
      }
      
      // Fallback to API endpoint
      try {
        const response = await fetch(`${API_BASE}/api/reports`);
        
        // Check if response is actually JSON (not HTML error page)
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          console.warn('API server not available - response is not JSON');
          showApiUnavailableMessage();
          return [];
        }
        
        if (!response.ok) {
          console.warn(`API returned error: ${response.status}`);
          return [];
        }
        
        const data = await response.json();
        hideApiUnavailableMessage();
        enableTestRunner();
        return Array.isArray(data) ? data : [];
      } catch (error) {
        console.error('Failed to fetch reports:', error);
        showApiUnavailableMessage();
        return [];
      }
    }
    
    function showApiUnavailableMessage() {
      // Only show once
      if (document.getElementById('api-unavailable-banner')) {
        return;
      }
      
      const banner = document.createElement('div');
      banner.id = 'api-unavailable-banner';
      banner.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
        color: white;
        padding: 1rem;
        text-align: center;
        z-index: 10000;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      `;
      banner.innerHTML = `
        <div style="max-width: 1200px; margin: 0 auto;">
          <strong>ðŸ“Š View-Only Mode</strong>
          <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem;">
            API server is not available. You can <strong>view existing reports</strong> below, but cannot run new tests.
            <br>
            To run tests: Start API server with <code style="background: rgba(0,0,0,0.2); padding: 0.25rem 0.5rem; border-radius: 4px;">npm run dashboard</code>
            <br>
            Or configure API URL: <code style="background: rgba(0,0,0,0.2); padding: 0.25rem 0.5rem; border-radius: 4px;">localStorage.setItem('API_BASE', 'http://your-api-url:3000')</code>
          </p>
        </div>
      `;
      document.body.insertBefore(banner, document.body.firstChild);
      
      // Disable test runner when API is unavailable
      const runTestBtn = document.getElementById('run-test-btn');
      const gameUrlInput = document.getElementById('game-url-input');
      if (runTestBtn) {
        runTestBtn.disabled = true;
        runTestBtn.title = 'API server not available - cannot run tests';
        runTestBtn.style.opacity = '0.6';
        runTestBtn.style.cursor = 'not-allowed';
      }
      if (gameUrlInput) {
        gameUrlInput.disabled = true;
        gameUrlInput.placeholder = 'API server not available - view-only mode';
        gameUrlInput.title = 'Cannot run tests - API server not available';
      }
    }
    
    function hideApiUnavailableMessage() {
      const banner = document.getElementById('api-unavailable-banner');
      if (banner) {
        banner.remove();
      }
      enableTestRunner();
    }
    
    function enableTestRunner() {
      const runTestBtn = document.getElementById('run-test-btn');
      const gameUrlInput = document.getElementById('game-url-input');
      if (runTestBtn) {
        runTestBtn.disabled = false;
        runTestBtn.title = '';
        runTestBtn.style.opacity = '1';
        runTestBtn.style.cursor = 'pointer';
      }
      if (gameUrlInput) {
        gameUrlInput.disabled = false;
        gameUrlInput.placeholder = 'Enter game URL (e.g., https://play2048.co/)';
        gameUrlInput.title = '';
      }
    }

    function renderStats(reports) {
      const statsContainer = document.getElementById('stats');
      
      if (reports.length === 0) {
        statsContainer.innerHTML = '';
        return;
      }

      const total = reports.length;
      const passed = reports.filter(r => r.status === 'pass').length;
      const avgScore = reports.reduce((sum, r) => sum + r.playability_score, 0) / total;
      const totalIssues = reports.reduce((sum, r) => sum + r.issues.length, 0);

      statsContainer.innerHTML = `
        <div class="stat-card">
          <div class="stat-value">${total}</div>
          <div class="stat-label">Total Tests</div>
        </div>
        <div class="stat-card">
          <div class="stat-value status-pass">${passed}</div>
          <div class="stat-label">Passed</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${avgScore.toFixed(1)}</div>
          <div class="stat-label">Avg Score</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${totalIssues}</div>
          <div class="stat-label">Total Issues</div>
        </div>
      `;
    }

    function getScoreClass(score) {
      if (score >= 80) return 'score-high';
      if (score >= 50) return 'score-medium';
      return 'score-low';
    }

    function formatDate(timestamp) {
      return new Date(timestamp).toLocaleString();
    }

    function renderReports(reports) {
      const reportsContainer = document.getElementById('reports');
      
      if (reports.length === 0) {
        reportsContainer.innerHTML = `
          <div class="empty-state">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <p>No test reports found</p>
            <p style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);">Use the test runner above to test a game</p>
          </div>
        `;
        return;
      }

      reportsContainer.innerHTML = reports.map((report, reportIndex) => {
        const statusClass = `badge-${report.status}`;
        const scoreClass = getScoreClass(report.playability_score);
        const allScreenshots = report.screenshots || [];
        
        return `
          <div class="report-card">
            <div class="report-header">
              <div class="report-title">${report.game_url}</div>
              <span class="report-badge ${statusClass}">${report.status}</span>
            </div>
            
            <div class="report-meta">
              <div class="meta-item">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                <span>${report.execution_time_seconds.toFixed(2)}s</span>
              </div>
              <div class="meta-item">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                  <circle cx="9" cy="9" r="2"></circle>
                  <path d="M21 15l-3.086-3.086a2 2 0 0 0-2.828 0L6 21"></path>
                </svg>
                <span>${report.screenshots.length} screenshots</span>
              </div>
              <div class="meta-item">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="12" y1="8" x2="12" y2="12"></line>
                  <line x1="12" y1="16" x2="12.01" y2="16"></line>
                </svg>
                <span>${report.issues.length} issues</span>
              </div>
              <div class="meta-item">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="16" y1="2" x2="16" y2="6"></line>
                  <line x1="8" y1="2" x2="8" y2="6"></line>
                  <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                <span>${formatDate(report.timestamp)}</span>
              </div>
            </div>

            <div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span style="font-size: 0.875rem; color: var(--text-secondary);">Playability Score</span>
                <span style="font-weight: 600;">${report.playability_score}/100</span>
              </div>
              <div class="score-bar">
                <div class="score-fill ${scoreClass}" style="width: ${report.playability_score}%"></div>
              </div>
            </div>

            ${report.issues.length > 0 ? `
              <div class="issues-list">
                ${report.issues.slice(0, 5).map(issue => {
                  const severityClass = issue.severity === 'critical' ? 'issue-critical' : 
                                      issue.severity === 'warning' ? 'issue-warning' : 'issue-info';
                  return `
                  <div class="issue-item ${severityClass}">
                    <span class="issue-severity">${issue.severity.toUpperCase()}:</span>
                    <span>${issue.description}</span>
                    ${issue.confidence ? `<span style="opacity: 0.7; font-size: 0.75rem; margin-left: 0.5rem;">(${Math.round(issue.confidence * 100)}%)</span>` : ''}
                  </div>
                `;
                }).join('')}
                ${report.issues.length > 5 ? `
                  <div style="color: var(--text-secondary); font-size: 0.875rem; margin-top: 0.75rem; padding-left: 1rem; font-style: italic;">
                    +${report.issues.length - 5} more ${report.issues.length - 5 === 1 ? 'issue' : 'issues'}
                  </div>
                ` : ''}
              </div>
            ` : ''}

            ${allScreenshots.length > 0 ? `
              <div class="screenshots-grid">
                ${allScreenshots.slice(0, 4).map((screenshot, idx) => {
                  const label = getScreenshotLabel(screenshot.label, idx);
                  return `
                  <div class="screenshot-item screenshot-clickable" data-screenshot-index="${idx}" data-report-index="${reportIndex}" title="Click to view full size - ${label}">
                    <img src="${screenshot.url || screenshot.storageUrl || `${API_BASE}/api/screenshots/${screenshot.filename}`}?t=${Date.now()}" alt="${label}" loading="lazy" onerror="this.onerror=null; this.style.display='none'; this.parentElement.innerHTML='<div style=\\'padding: 2rem; text-align: center; color: var(--text-secondary); font-size: 0.875rem;\\'>Screenshot not available<br><small>File: ${screenshot.filename}</small></div>'">
                    <div class="screenshot-label-overlay">
                      <div class="screenshot-label-text">${label}</div>
                      <div class="screenshot-label-time">${new Date(screenshot.timestamp).toLocaleTimeString()}</div>
                    </div>
                  </div>
                `;
                }).join('')}
                ${allScreenshots.length > 4 ? `
                  <div class="screenshot-more screenshot-clickable" data-report-index="${reportIndex}" data-total="${allScreenshots.length}" title="View all ${allScreenshots.length} screenshots">
                    +${allScreenshots.length - 4} more
                  </div>
                ` : ''}
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
      
      // Add click handlers for screenshots after rendering
      setTimeout(() => {
        const clickableScreenshots = document.querySelectorAll('.screenshot-clickable');
        clickableScreenshots.forEach(el => {
          // Remove existing listeners to avoid duplicates
          const newEl = el.cloneNode(true);
          el.parentNode?.replaceChild(newEl, el);
          
          newEl.addEventListener('click', function() {
            const reportIdx = parseInt(this.dataset.reportIndex);
            const screenshotIdx = parseInt(this.dataset.screenshotIndex || 0);
            const report = reports[reportIdx];
            if (report && report.screenshots) {
              openScreenshotModal(report.screenshots, screenshotIdx);
            }
          });
        });
      }, 100);
    }

    // Pipeline Animation Logic
    const steps = document.querySelectorAll('.pipeline-step');

    function resetPipeline() {
      steps.forEach(step => {
        step.classList.remove('active', 'completed');
      });
    }


    // Toggle pipeline visibility
    document.getElementById('toggle-pipeline')?.addEventListener('click', function() {
      const pipeline = document.getElementById('pipeline-demo');
      if (pipeline.style.display === 'none') {
        pipeline.style.display = 'block';
        this.textContent = 'Hide';
      } else {
        pipeline.style.display = 'none';
        this.textContent = 'Show';
      }
    });


    // Pipeline is hidden by default, shown when test starts
    const pipelineDemo = document.getElementById('pipeline-demo');

    // Test Runner Functionality
    const gameUrlInput = document.getElementById('game-url-input');
    const runTestBtn = document.getElementById('run-test-btn');
    const testStatus = document.getElementById('test-status');
    let testPollInterval = null;

    async function runTest() {
      const gameUrl = gameUrlInput?.value?.trim();
      
      if (!gameUrl) {
        showTestStatus('Please enter a game URL', 'error');
        return;
      }

      // Validate URL
      try {
        new URL(gameUrl);
      } catch {
        showTestStatus('Invalid URL format. Please enter a valid URL (e.g., https://play2048.co/)', 'error');
        return;
      }

      // Disable button and show loading
      if (runTestBtn) {
        runTestBtn.disabled = true;
        runTestBtn.querySelector('.btn-text').textContent = 'Testing...';
        runTestBtn.querySelector('.btn-spinner').style.display = 'inline';
      }

      // Store game URL for browser simulation BEFORE starting animation
      currentGameUrl = gameUrl;
      
      // Don't show text status - animation will show progress
      if (testStatus) {
        testStatus.style.display = 'none';
      }

      try {
        // Start animation FIRST so browser shows URL immediately
        startTestAnimation();
        
        const showBrowser = document.getElementById('show-browser-checkbox')?.checked || false;
        
        const response = await fetch(`${API_BASE}/api/test`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ gameUrl, showBrowser }),
        });

        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          throw new Error('API server not available. Please start the dashboard server with: npm run dashboard');
        }

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Failed to start test');
        }

        // Start polling for completion (animation already started)
        startPolling();

      } catch (error) {
        showTestStatus(`Error: ${error.message}`, 'error');
        if (runTestBtn) {
          runTestBtn.disabled = false;
          runTestBtn.querySelector('.btn-text').textContent = 'Run Test';
          runTestBtn.querySelector('.btn-spinner').style.display = 'none';
        }
      }
    }

    function showTestStatus(message, type) {
      if (testStatus) {
        testStatus.style.display = 'block';
        testStatus.className = `test-status ${type}`;
        testStatus.innerHTML = message;
      }
    }

    let testAnimationInterval = null;

    let currentGameUrl = '';

    function startTestAnimation() {
      // Reset pipeline
      resetPipeline();
      
      // Hide text status
      if (testStatus) {
        testStatus.style.display = 'none';
      }
      
      // Show browser simulation
      const browserSim = document.getElementById('browser-simulation');
      if (browserSim) {
        browserSim.style.display = 'block';
        // Initialize browser window - show actual game URL immediately
        showBrowserState('Opening browser...');
        // Use the stored game URL or show loading state
        if (currentGameUrl) {
          updateBrowserUrl(currentGameUrl);
          showBrowserLoading();
        } else {
          updateBrowserUrl('about:blank');
          showBrowserLoading();
        }
      }
      
      // Show pipeline animation
      if (pipelineDemo) {
        pipelineDemo.style.display = 'block';
        // Smooth scroll to show the animation
        setTimeout(() => {
          browserSim?.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }, 100);
      }
      
      // Start with first step (load game) - will update based on real test phases
      steps[0].classList.add('active');
      
      // Animation updates automatically via polling based on actual test phase
    }

    function showBrowserState(message) {
      const statusEl = document.getElementById('browser-status');
      if (statusEl) {
        statusEl.textContent = message;
        statusEl.className = 'browser-status loading';
      }
    }

    function updateBrowserUrl(url) {
      const urlEl = document.getElementById('browser-url');
      if (urlEl) {
        urlEl.textContent = url;
        currentGameUrl = url;
      }
    }

    function showBrowserLoading() {
      const pageEl = document.getElementById('browser-page');
      if (pageEl) {
        const urlToShow = currentGameUrl || 'game';
        pageEl.innerHTML = `
          <div class="browser-loading">
            <div class="spinner-small"></div>
            <p>Loading ${urlToShow}...</p>
            <p style="margin-top: 1rem; font-size: 0.75rem; color: #999;">Please wait...</p>
          </div>
        `;
      }
    }

    function showBrowserGame(message = 'Game is running...') {
      const pageEl = document.getElementById('browser-page');
      if (pageEl) {
        pageEl.innerHTML = `
          <div class="browser-game-content">
            <h2>Game Loaded</h2>
            <p>${message}</p>
            <div style="margin-top: 2rem; padding: 2rem; background: #f5f5f5; border-radius: 8px;">
              <p style="color: #666; font-size: 0.875rem;">Simulating gameplay interactions...</p>
            </div>
          </div>
        `;
      }
      
      const statusEl = document.getElementById('browser-status');
      if (statusEl) {
        statusEl.textContent = 'Game running';
        statusEl.className = 'browser-status';
      }
    }

    function showBrowserError(errorMessage) {
      const pageEl = document.getElementById('browser-page');
      if (pageEl) {
        // Check if it's a quota limit error
        const isQuotaError = errorMessage && (
          errorMessage.includes('quota') || 
          errorMessage.includes('402') || 
          errorMessage.includes('Payment Required') ||
          errorMessage.includes('browser minutes limit')
        );
        
        let errorContent = '';
        if (isQuotaError) {
          errorContent = `
            <div class="browser-game-content" style="color: #d32f2f;">
              <h2 style="color: #d32f2f;">Browserbase Quota Limit Reached</h2>
              <p style="color: #666; margin-top: 1rem;">Your free plan browser minutes have been exhausted.</p>
              <div style="margin-top: 2rem; padding: 1.5rem; background: #fff3e0; border: 1px solid #ff9800; border-radius: 8px;">
                <p style="color: #e65100; font-size: 0.875rem; margin: 0 0 1rem 0;">
                  <strong>Solutions:</strong>
                </p>
                <ul style="color: #e65100; font-size: 0.875rem; margin: 0; padding-left: 1.5rem;">
                  <li>Upgrade your Browserbase account at <a href="https://browserbase.com/plans" target="_blank" style="color: #1976d2;">https://browserbase.com/plans</a></li>
                  <li>Wait for your monthly quota to reset</li>
                  <li>Check your quota usage at <a href="https://browserbase.com/dashboard" target="_blank" style="color: #1976d2;">Browserbase Dashboard</a></li>
                </ul>
              </div>
            </div>
          `;
        } else {
          errorContent = `
            <div class="browser-game-content" style="color: #d32f2f;">
              <h2 style="color: #d32f2f;">Error Loading Game</h2>
              <p style="color: #666; margin-top: 1rem;">${errorMessage || 'Failed to load game. Please check the URL and try again.'}</p>
              <div style="margin-top: 2rem; padding: 1.5rem; background: #ffebee; border: 1px solid #ef5350; border-radius: 8px;">
                <p style="color: #c62828; font-size: 0.875rem; margin: 0;">
                  <strong>Possible causes:</strong><br>
                  â€¢ Invalid game URL<br>
                  â€¢ Game requires user interaction before loading<br>
                  â€¢ Network connectivity issues<br>
                  â€¢ Browser automation service unavailable
                </p>
              </div>
            </div>
          `;
        }
        
        pageEl.innerHTML = errorContent;
      }
      
      const statusEl = document.getElementById('browser-status');
      if (statusEl) {
        statusEl.textContent = errorMessage || 'Error occurred';
        statusEl.className = 'browser-status error';
      }
    }

    function hideBrowserSimulation() {
      const browserSim = document.getElementById('browser-simulation');
      if (browserSim) {
        browserSim.style.display = 'none';
      }
    }

    function stopTestAnimation() {
      // Clear phase message interval
      if (phaseMessageInterval) {
        clearInterval(phaseMessageInterval);
        phaseMessageInterval = null;
      }
      
      // Hide all status messages
      steps.forEach(step => {
        const statusEl = step.querySelector('.step-status');
        if (statusEl) {
          statusEl.style.display = 'none';
        }
      });
    }

    // Phase status messages
    const phaseMessages = {
      'load': ['Opening browser...', 'Creating browser session...', 'Navigating to game URL...', 'Waiting for game to load...'],
      'capture': ['Initializing capture...', 'Taking initial screenshot...', 'Capturing console logs...', 'Saving evidence...'],
      'interact': ['Detecting UI elements...', 'Clicking start button...', 'Simulating gameplay...', 'Capturing gameplay screenshots...'],
      'analyze': ['Loading screenshots...', 'Sending to GPT-4 Vision...', 'Analyzing playability...', 'Processing results...'],
      'report': ['Generating report...', 'Calculating scores...', 'Categorizing issues...', 'Saving report file...'],
      'complete': ['Test completed successfully!', '', '', '']
    };

    let currentPhaseMessageIndex = 0;
    let phaseMessageInterval = null;

    function updateAnimationForPhase(phase) {
      // Map backend phases to animation steps
      const phaseMap = {
        'load': 0,        // Step 1: Load Game
        'capture': 1,    // Step 2: Capture Evidence
        'interact': 2,   // Step 3: Interact
        'analyze': 3,    // Step 4: AI Analysis
        'report': 4,     // Step 5: Generate Report
        'complete': 4,   // Step 5: Complete
        'error': 4       // On error, show up to last step
      };

      const stepIndex = phaseMap[phase];
      
      // Update browser simulation based on phase
      if (phase === 'load') {
        showBrowserState('Navigating to game URL...');
        // Ensure URL is set if not already
        if (currentGameUrl && currentGameUrl !== 'about:blank') {
          updateBrowserUrl(currentGameUrl);
        }
        // Show loading state with proper URL
        showBrowserLoading();
        
        // Simulate page load progress
        setTimeout(() => {
          if (currentGameUrl && currentGameUrl !== 'about:blank') {
            const pageEl = document.getElementById('browser-page');
            if (pageEl) {
              pageEl.innerHTML = `
                <div class="browser-loading">
                  <div class="spinner-small"></div>
                  <p>Loading ${currentGameUrl}...</p>
                  <p style="margin-top: 1rem; font-size: 0.75rem; color: #999;">Establishing connection...</p>
                </div>
              `;
            }
          }
        }, 1000);
      } else if (phase === 'capture') {
        showBrowserState('Capturing screenshots...');
        showBrowserGame('Game loaded successfully. Capturing evidence...');
      } else if (phase === 'interact') {
        showBrowserState('Interacting with game...');
        showBrowserGame('Simulating gameplay interactions...');
        
        // Add visual indicators of interaction
        setTimeout(() => {
          const pageEl = document.getElementById('browser-page');
          if (pageEl && pageEl.innerHTML.includes('Simulating gameplay')) {
            const content = pageEl.querySelector('.browser-game-content');
            if (content) {
              content.innerHTML = `
                <h2>Game Loaded</h2>
                <p>Simulating gameplay interactions...</p>
                <div style="margin-top: 2rem; padding: 2rem; background: #f5f5f5; border-radius: 8px;">
                  <div style="display: flex; align-items: center; justify-content: center; gap: 1rem; margin-bottom: 1rem;">
                    <div style="width: 40px; height: 40px; background: #2196F3; border-radius: 8px; animation: pulse 2s infinite;"></div>
                    <div style="width: 40px; height: 40px; background: #4CAF50; border-radius: 8px; animation: pulse 2s infinite; animation-delay: 0.3s;"></div>
                    <div style="width: 40px; height: 40px; background: #FF9800; border-radius: 8px; animation: pulse 2s infinite; animation-delay: 0.6s;"></div>
                  </div>
                  <p style="color: #666; font-size: 0.875rem; margin: 0;">Detecting UI elements and simulating user interactions...</p>
                </div>
              `;
            }
          }
        }, 500);
      } else if (phase === 'analyze') {
        showBrowserState('Analyzing with AI...');
        // Keep game visible during analysis
        showBrowserGame('Processing captured evidence with GPT-4 Vision...');
      } else if (phase === 'report') {
        showBrowserState('Generating report...');
        // Keep game visible during report generation
        showBrowserGame('Generating test report...');
      } else if (phase === 'error' || phase === 'failed') {
        showBrowserError('Test failed during execution. Check results below for details.');
      } else if (phase === 'complete') {
        showBrowserState('Test completed successfully');
        showBrowserGame('Test completed! Closing browser...');
        setTimeout(() => {
          hideBrowserSimulation();
        }, 3000);
      } else if (phase === 'idle') {
        // Reset browser simulation
        if (currentGameUrl) {
          updateBrowserUrl(currentGameUrl);
        } else {
          updateBrowserUrl('about:blank');
        }
        showBrowserLoading();
      }
      
      if (stepIndex !== undefined) {
        // Clear previous phase message intervals
        if (phaseMessageInterval) {
          clearInterval(phaseMessageInterval);
          phaseMessageInterval = null;
        }

        // Update animation to show progress up to current phase
        steps.forEach((step, index) => {
          const statusEl = step.querySelector('.step-status');
          
          step.classList.remove('active');
          
          if (index < stepIndex) {
            // Previous steps are completed
            step.classList.add('completed');
            step.classList.remove('active');
            if (statusEl) {
              statusEl.style.display = 'none';
            }
          } else if (index === stepIndex) {
            // Current step is active - show real-time status
            step.classList.add('active');
            step.classList.remove('completed');
            
            // Show status messages for current phase
            if (statusEl && phaseMessages[phase]) {
              statusEl.style.display = 'block';
              currentPhaseMessageIndex = 0;
              
              // Update message immediately
              statusEl.textContent = phaseMessages[phase][currentPhaseMessageIndex] || '';
              
              // Rotate through messages every 2-3 seconds
              phaseMessageInterval = setInterval(() => {
                currentPhaseMessageIndex++;
                if (currentPhaseMessageIndex < phaseMessages[phase].length) {
                  statusEl.textContent = phaseMessages[phase][currentPhaseMessageIndex];
                } else {
                  // Loop back or stay on last message
                  currentPhaseMessageIndex = 0;
                  statusEl.textContent = phaseMessages[phase][currentPhaseMessageIndex];
                }
              }, 2500);
            }
          } else {
            // Future steps are inactive
            step.classList.remove('completed', 'active');
            if (statusEl) {
              statusEl.style.display = 'none';
            }
          }
        });
      }
    }

    function startPolling() {
      // Clear any existing interval
      if (testPollInterval) {
        clearInterval(testPollInterval);
      }

      let pollCount = 0;
      const maxPolls = 120; // 2 minutes max (120 * 1 second)

      testPollInterval = setInterval(async () => {
        pollCount++;
        
        try {
          const response = await fetch(`${API_BASE}/api/test/status`);
          
          // Check if response is JSON
          const contentType = response.headers.get('content-type');
          if (!contentType || !contentType.includes('application/json')) {
            console.warn('API server not available during polling');
            return; // Skip this poll
          }
          
          const data = await response.json();

          // Update animation based on current phase (always update during test)
          // Update immediately on first poll, then continue updating
          if (data.phase) {
            updateAnimationForPhase(data.phase);
            console.log('Phase update:', data.phase, 'Running:', data.running);
          }

          if (!data.running && pollCount > 5) {
            // Test completed (successfully or with error)
            clearInterval(testPollInterval);
            stopTestAnimation();
            
            // Final phase update if we haven't seen it yet
            if (data.phase) {
              updateAnimationForPhase(data.phase);
            }
            
            // Complete all pipeline steps
            stopTestAnimation(); // Clear any intervals
            steps.forEach(step => {
              step.classList.remove('active');
              // Only mark as completed if test succeeded
              if (data.phase !== 'error' && data.phase !== 'failed') {
                step.classList.add('completed');
              }
              const statusEl = step.querySelector('.step-status');
              if (statusEl) {
                statusEl.style.display = 'none';
              }
            });
            
            // Show final browser state before hiding
            const hasError = data.phase === 'error' || data.phase === 'failed' || data.error;
            if (hasError) {
              const errorMsg = data.error || 'Test failed. Check results below for details.';
              showBrowserError(errorMsg);
              // Keep browser visible for errors so user can see what happened
              setTimeout(() => {
                hideBrowserSimulation();
              }, 8000); // Keep visible longer for quota errors
              showTestStatus('Test failed. See details below.', 'error');
            } else {
              // Hide browser simulation after showing completion
              setTimeout(() => {
                hideBrowserSimulation();
              }, 3000);
              showTestStatus('Test completed! Refreshing results...', 'success');
            }
            
            // Refresh reports after a short delay
            setTimeout(async () => {
              const reports = await fetchReports();
              renderStats(reports);
              renderReports(reports);
              showTestStatus('Results updated! Scroll down to see the test report.', 'success');
            }, 2000);

            // Reset button
            if (runTestBtn) {
              runTestBtn.disabled = false;
              runTestBtn.querySelector('.btn-text').textContent = 'Run Test';
              runTestBtn.querySelector('.btn-spinner').style.display = 'none';
            }
          } else if (data.running) {
            // Show reset button if test has been running for more than 2 minutes (likely stuck)
            const resetBtn = document.getElementById('reset-test-btn');
            if (resetBtn && data.elapsedTime && data.elapsedTime > 120) {
              resetBtn.style.display = 'block';
              resetBtn.onclick = async () => {
                if (confirm('Reset stuck test? This will stop the current test and allow you to start a new one.')) {
                  try {
                    const response = await fetch('/api/test/reset', { method: 'POST' });
                    if (response.ok) {
                      resetBtn.style.display = 'none';
                      location.reload(); // Reload to refresh state
                    }
                  } catch (error) {
                    console.error('Reset failed:', error);
                  }
                }
              };
            }
            
            // Update animation based on actual test phase (if available)
            if (data.phase) {
              updateAnimationForPhase(data.phase);
            } else {
              // Fallback: show first step if phase not available yet
              if (pollCount === 1) {
                updateAnimationForPhase('load');
              }
            }
          }
        } catch (error) {
          console.error('Polling error:', error);
        }

        if (pollCount >= maxPolls) {
          clearInterval(testPollInterval);
          stopTestAnimation();
          showTestStatus('Test is taking longer than expected. Check reports below.', 'running');
          if (runTestBtn) {
            runTestBtn.disabled = false;
            runTestBtn.querySelector('.btn-text').textContent = 'Run Test';
            runTestBtn.querySelector('.btn-spinner').style.display = 'none';
            
            // Hide reset button when test is not running
            const resetBtn = document.getElementById('reset-test-btn');
            if (resetBtn) {
              resetBtn.style.display = 'none';
            }
          }
        }
      }, 1000);
    }

    // Event listeners
    runTestBtn?.addEventListener('click', runTest);
    gameUrlInput?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        runTest();
      }
    });

    // Pre-fill with example URL on focus
    gameUrlInput?.addEventListener('focus', function() {
      if (!this.value) {
        this.placeholder = 'https://play2048.co/';
      }
    });

    async function loadDashboard() {
      const reportsContainer = document.getElementById('reports');
      reportsContainer.innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <p>Loading reports...</p>
        </div>
      `;

      const reports = await fetchReports();
      renderStats(reports);
      renderReports(reports);

      // Auto-refresh every 30 seconds
      setInterval(async () => {
        const newReports = await fetchReports();
        renderStats(newReports);
        renderReports(newReports);
      }, 30000);
    }

    loadDashboard();
  </script>
</body>
</html>

